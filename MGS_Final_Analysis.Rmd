---
title: "MGS_Occupancy_Final_Analysis"
author: "Annie Kellner"
date: "2025-05-29"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
```

```{r load-libraries, message=FALSE, warning=FALSE, include=FALSE}

library(tidyverse)
library(unmarked)
library(MuMIn)
library(sf)
library(tmap)
library(tmaptools)
library(viridisLite)

```


```{r load-data}

finalUMF <- readRDS("./Data/UMFs/umf_CORRECT_06022025.Rds")

finalDF <- readRDS("./Data/indCams_adults_envCovs_06022025.Rds")

```



## Model 1: Intercept-Only

```{r intercept-only, warning=FALSE}

m1 <- occu(~ 1 ~ 1,
           data = finalUMF,
           linkPsi = "logit")

```


## Model 2: Detection Trend Only (date terms: linear + quadratic)

```{r det-trend-only, warning=FALSE}

m2 <- occu(~ scOrdinal + scOrdinal2 ~ 1,
           data = finalUMF,
           linkPsi = "logit")
```


## Model 3: Detection Trend (date terms) + Occupancy Trend (distance to stream)

```{r all-trends, warning=FALSE}

m3 <- occu(~ scOrdinal + scOrdinal2 ~ Dist_Scaled,
           data = finalUMF,
           linkPsi = "logit")

```


## Model 4: No detection trend; Occupancy Trend (distance to stream)

```{r warning=FALSE}

m4 <- occu(~ 1 ~ Dist_Scaled,
           data = finalUMF,
           linkPsi = "logit")

```


## Model 5: Linear Detection trend only; Occupancy Trend (distance to streams)

```{r}

m5 <- occu(~scOrdinal ~ Dist_Scaled,
           data = finalUMF)


```


## AIC Analysis

```{r}

model_list <- list(
  "Intercept-Only" = m1,
  "Detection_Trend_Only" = m2,
  "Detection_and_Occupancy_Covs" = m3,
  "Occupancy_Cov_only" = m4,
  "No_Quadratic_Term" = m5
)


# Calculate AICc for each model

aicc_values <- sapply(model_list, function(x) {
  AICc(x)
})

# Create comparison table

model_comparison <- data.frame(
  Model = names(model_list),
  AICc = aicc_values,
  Delta_AICc = aicc_values - min(aicc_values)
)

# Sort by AICc

model_comparison <- model_comparison[order(model_comparison$AICc),]

model_comparison

```


## Detection and Occupancy Probabilities

The following are means and ranges for occupancy and detection probabilities across all sites and throughout the study duration. 


```{r top-model-probabilities, warning=FALSE}

occuProbs <- predict(m5, type = "state")
detProbs <- predict(m5, type = "det")

cat("Mean Occupancy Probability:", round(mean(occuProbs$Predicted),digits = 3), "\n") 
cat("Range of Occupancy Probability:", round(range(occuProbs$Predicted), digits = 3), "\n")

cat("Mean Detection Probability:", round(mean(detProbs$Predicted), digits = 3), "\n")
cat("Range in Detection Probability:", round(range(detProbs$Predicted), digits = 3), "\n")

```

## Detection Probability Over Time

```{r plot-detection-prob}

# Create dataframe with detProbs and dates

detProbDF <- data.frame(
  "Date" = colnames(finalDF[,2:111]),
  "Detection_Prob" = detProbs$Predicted
)

detProbDF$Date <- mdy(detProbDF$Date)

ggplot(detProbDF, aes(x = Date, y = Detection_Prob)) + 
  geom_point() + 
  geom_line() + 
  scale_x_date(date_breaks = "5 days",
               date_labels = "%m/%d") +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Date", y = "Detection Probability")


```

## Actual captures over time

```{r plot-captures-over-time}

counts <- finalDF %>%
  summarize(across(2:111, sum, na.rm = TRUE))

counts_long <- counts %>%
  pivot_longer(everything(),
               names_to = "Date",
               values_to = "Total_Detections") 

counts_long <- counts_long %>% mutate(Date = mdy(Date))


# Plot Count Data

ggplot(counts_long, aes(x = Date, y = Total_Detections)) +
  geom_line() +
  theme_minimal() +
  labs(x = "Date",
       y = "Number of Detections",
       title = "Daily Detection Counts") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_x_date(date_breaks = "5 days",  # Show every 5 days
               date_labels = "%m/%d")    # Format as month/day


```


## Detection Probability over time for M3

```{r}

occuProbs <- predict(m3, type = "state")
detProbs <- predict(m3, type = "det")

head(counts_long)
tail(counts_long)




```

```{r}





```






## Interactive Map

```{r}

## Load and prep data

site_info <- scaledUMF@obsCovs



# Load data

streams <- st_read("./Data/Spatial/Habitat/Water_features/WaterFeature_L.shp") # river shp
indCams <- readRDS("./Data/Detection/Derived/Detection_NAs_indCams_adultsOnly.Rds") # to exclude non-independent cams
camCoords <- readRDS("./Data/Spatial/camCoords_withEnv_05262025.Rds")

# Remove non-independent cameras and cameras without data

indCams[53,] # AFRL-NW-05 - no data
indCams[107,] # HQA-38-03 - no data

indCams <- indCams %>%
  filter(!(Camera_Name == "AFRL-NW-05" | 
              Camera_Name == "HQA-38-03"))

indCamNames <- indCams$Camera_Name

camCoordsInd <- camCoords %>%
  filter(Camera_Name %in% indCamNames) %>%
  











```



