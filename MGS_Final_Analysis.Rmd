---
title: "MGS_Occupancy_Final_Analysis"
author: "Annie Kellner"
date: "2025-05-29"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
```

```{r load-libraries}

library(tidyverse)
library(unmarked)
library(MuMIn)
library(sf)
library(tmap)
library(tmaptools)
library(viridisLite)

```


```{r load-data}

umf1 <- readRDS("./Data/UMFs/umf_independentCams_adults.Rds")

finalUMF <- readRDS("./Data/UMFs/finalUMF_05292025.Rds")



```



## Model 1: Intercept-Only

```{r intercept-only}

m1 <- occu(~ 1 ~ 1,
           data = umf1,
           linkPsi = "logit")

```


## Model 2: Detection Trend Only (date terms: linear + quadratic)

```{r det-trend-only}

m2 <- occu(~ scOrdinal + scOrdinal2 ~ 1,
           data = umf1,
           linkPsi = "logit")
```


## Model 3: Detection Trend (date terms) + Occupancy Trend (distance to stream)

```{r all-trends}

m3 <- occu(~ scOrdinal + scOrdinal2 ~ Dist_to_Stream,
           data = finalUMF,
           linkPsi = "logit")

```


## Model 4: No detection trend; Occupancy Trend (distance to stream)

```{r}

m4 <- occu(~ 1 ~ Dist_to_Stream,
           data = finalUMF,
           linkPsi = "logit")

```


## AIC Analysis

```{r}

model_list <- list(
  "Intercept-Only" = m1,
  "Detection_Trend_Only" = m2,
  "Detection_and_Occupancy_Covs" = m3,
  "Occupancy_Cov_only" = m4
)


# Calculate AICc for each model

aicc_values <- sapply(model_list, function(x) {
  AICc(x)
})

# Create comparison table

model_comparison <- data.frame(
  Model = names(model_list),
  AICc = aicc_values,
  Delta_AICc = aicc_values - min(aicc_values)
)

# Sort by AICc

model_comparison <- model_comparison[order(model_comparison$AICc),]

model_comparison

```

## Scaling Distance to Stream

```{r}

# load scaled UMF

scaledUMF <- readRDS("./Data/UMFs/umf_adultsOnly_indCams_streamsOnly_allScaled.Rds")


m3scaled <- occu(~ scOrdinal + scOrdinal2 ~ Dist_to_Stream,
           data = scaledUMF,
           linkPsi = "logit")

```



## Detection and Occupancy Probabilities

I am providing means and ranges for occupancy and detection probabilities across all sites and throughout the study duration.

Next I will provide site-specific occupancy probability through an interactive map as well as a plot of detection probability over time. 


```{r m3-unscaledStreams}

occuProbs <- predict(m3, type = "state")
detProbs <- predict(m3, type = "det")

cat("Mean Occupancy Probability:", mean(occuProbs$Predicted), "\n") 
cat("Range of Occupancy Probability:", range(occuProbs$Predicted), "\n")

cat("Mean Detection Probability:", mean(detProbs$Predicted), "\n")
cat("Range in Detection Probability:", range(detProbs$Predicted), "\n")

```

```{r m3-scaled}

occuProbs <- predict(m3scaled, type = "state")
detProbs <- predict(m3scaled, type = "det")

cat("Mean Occupancy Probability:", mean(occuProbs$Predicted), "\n") 
cat("Range of Occupancy Probability:", range(occuProbs$Predicted), "\n")

cat("Mean Detection Probability:", mean(detProbs$Predicted), "\n")
cat("Range in Detection Probability:", range(detProbs$Predicted), "\n")



```


## Interactive Map

```{r}

## Load and prep data

site_info <- scaledUMF@obsCovs



# Load data

streams <- st_read("./Data/Spatial/Habitat/Water_features/WaterFeature_L.shp") # river shp
indCams <- readRDS("./Data/Detection/Derived/Detection_NAs_indCams_adultsOnly.Rds") # to exclude non-independent cams
camCoords <- readRDS("./Data/Spatial/camCoords_withEnv_05262025.Rds")

# Remove non-independent cameras and cameras without data

indCams[53,] # AFRL-NW-05 - no data
indCams[107,] # HQA-38-03 - no data

indCams <- indCams %>%
  filter(!(Camera_Name == "AFRL-NW-05" | 
              Camera_Name == "HQA-38-03"))

indCamNames <- indCams$Camera_Name

camCoordsInd <- camCoords %>%
  filter(Camera_Name %in% indCamNames) %>%
  











```



