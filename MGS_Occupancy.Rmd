---
title: "MGS_Occupancy"
author: "Annie Kellner"
date: "2025-04-30"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```



```{r libraries}

library(tidyverse)
library(unmarked)
library(kableExtra)
library(terra)

```


### Tabulating data


```{r load-data}

detNA <- readRDS("./Data/detection_withNAs.Rds") # detections with NA's subbed for non-operational camera days
cams <- readRDS("./Data/camera_operation.Rds")

# Tabulate 0's, 1's, NA's

tabData <- detNA %>%
  select(-1) %>%
  pivot_longer(everything()) %>%
  count(value) %>%
  arrange(value) 

kableExtra::kbl(tabData) %>%
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                            position = "center") %>%
  kableExtra::row_spec(0, bold = TRUE)  # Makes header row bold

```


```{r}

tabCams <- cams %>%
  select(-1) %>%
  pivot_longer(everything()) %>%
  count(value) %>%
  arrange(value) 

kableExtra::kbl(tabCams) %>%
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                            position = "center") %>%
  kableExtra::row_spec(0, bold = TRUE)  # Makes header row bold

```


# Modeling

## Model 1
  - All Animals
  - All Cameras
  - Detection Trend
  - Random Effect of Individual Camera

```{r}

#umf <- readRDS('./Data/umf_05152025.Rds')

# Model 
  # quadratic term on ordinal date (for parabolic detection prob)
  # random effect for individual camera

mgs.occu <- occu(~ scOrdinal + scOrdinal2 ~ (1|Camera_Name),
                 data = umf_env_all,
                 linkPsi = "logit")

pred_scaled <- predict(mgs.occu, type = "state") # occupancy
pred_det <- predict(mgs.occu, type = "det") # detection



cat("Range (occupancy probability):", range(pred_scaled$Predicted))
cat("Mean (occupancy probability):", mean(pred_scaled$Predicted))

cat("Range (detection probability):", range(pred_det$Predicted))
cat("Mean (detection probability):", mean(pred_det$Predicted))
```

## Model 2: same as 1 but *without* detection trend


```{r}

mgs.occu.noDet <- occu(~ 1 ~ 1 + (1|site),
                       data = umf,
                       linkPsi = "logit")

noDet_pred <- predict(mgs.occu.noDet, type = "state") # "state is occupancy probability; "det" is detection probability

noDet_pred

```

This model is too simplistic because it does not account for any spatiotemporal variation (besides individual camera, which does not absorb much variation). 

It cannot distinguish between absence and non-detection, so the 95% CI is (0,1).


## Model 3: same as 1 but adults only

```{r sub-NAs-adults-only-all-cams}

adultsOnly_all <- Occupancy_All_MGS_Data_Adults_Only

adultsOnly_all <- adultsOnly_all %>% # remove white space at end of csv
  select(where(~!all(is.na(.)))) # only remove NA's when whole row is NA

camsAll <- readRDS("./Data/camera_operation.Rds") # no white space

##  --  SUB NA FOR NON-OPERATIONAL DAYS --  ##

adultsOnly_all <- adultsOnly_all %>%
  mutate(across(2:ncol(.), function(x) {
    col_name <- cur_column() # current column
    ifelse(camsAll[[col_name]] == 0, NA, x)
  }))


adultsOnly_all %>% # Tabulate
  select(-1) %>%
  pivot_longer(everything()) %>%
  count(value) %>%
  arrange(value)

#saveRDS(adultsOnly_all, file = './Data/allCams_adultsOnly.Rds')

```

```{r format-umf-adults-only-all-cams}

###   --    COVARIATES  --  ##

y <- as.matrix(allCams_adultsOnly[,c(2:ncol(allCams_adultsOnly))]) # 0/1 observations

# Create obsCovs

obsCovs <- list(
  scOrdinal = matrix(scOrdinal, 
                  nrow = nrow(y), 
                  ncol = ncol(y), 
                  byrow = TRUE),
  scOrdinal2 = matrix(scOrdinal^2, 
                    nrow = nrow(y),
                    ncol = ncol(y),
                    byrow = TRUE))

# Create siteCovs

siteCovs <- adultsOnly_all$Camera_Name


# UMF Creation

umf_adultsOnly_allCams <- unmarkedFrameOccu(
  y = y,
  siteCovs = data.frame(site = siteCovs),
  obsCovs = obsCovs
)

#saveRDS(umf_adultsOnly_allCams, file = "./Data/umf_adultsOnly_allCams_noEnv.Rds")

```


The Adults-only model was problematic, probably due to the dearth of data. It did provide estimates, but NA's were produced during the calculation of SE


```{r model-adults-only-all-cams}

model_adultsOnly_allCams <- occu(~ scOrdinal + scOrdinal2 ~ 1 + (1|site),
                                 data = umf_adultsOnly_allCams,
                                 linkPsi = "logit")

occuProb <- predict(model_adultsOnly_allCams, type = "state") # occupancy
detProb <- predict(model_adultsOnly_allCams, type = "det") # detection



cat("Range (occupancy probability):", range(occuProb$Predicted))
cat("Mean (occupancy probability):", mean(occuProb$Predicted))

cat("Range (detection probability):", range(detProb$Predicted))
cat("Mean (detection probability):", mean(detProb$Predicted))

```

*Plotting Detection Probability trend for adults only*

```{r}

pred_matrix <- matrix(detProb$Predicted, 
                     nrow = nrow(umf_adultsOnly_allCams@y),
                     ncol = ncol(umf_adultsOnly_allCams@y))

# Calculate mean predictions for each date (excluding NA sites)
mean_preds <- colMeans(pred_matrix[-c(84, 183), ], na.rm = TRUE)

dates <- head(dates, -1)

detProbDF <- data.frame("Date" = dates,
                        "Mean_Detection_Prob" = mean_preds)

ggplot(detProbDF, aes(x = Date, y = Mean_Detection_Prob)) +
  geom_line() +
  theme_minimal() +
  labs(x = "Date",
       y = "Detection Probability",
       title = "Mean Detection Probability Over Time") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_x_date(date_breaks = "5 days",  # Show every 5 days
               date_labels = "%m/%d")  

```


*Plotting Count Trend*

```{r}

counts <- allCams_adultsOnly %>%
  summarize(across(-1, sum, na.rm = TRUE))


counts_long <- counts %>%
  pivot_longer(everything(),
               names_to = "Date",
               values_to = "Count") 

counts_long <- counts_long %>% mutate(Date = mdy(Date))


# Plot Count Data

ggplot(counts_long, aes(x = Date, y = Count)) +
  geom_line() +
  theme_minimal() +
  labs(x = "Date",
       y = "Number of Detections",
       title = "Daily Detection Counts") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_x_date(date_breaks = "5 days",  # Show every 5 days
               date_labels = "%m/%d")    # Format as month/day

```

# Model 4: 
  - All animals
  - Independent cameras only
  - Detection trend
  
```{r data-prep-independent-cameras}

indCams <- Occupancy_Operational_Camera_Days_MGS_Data_Independent_Cameras_Only
indDet <- Occupancy_MGS_Data_Independent_Cameras_Only

# Remove white space

indCams <- indCams %>%
  select(where(~!all(is.na(.))))


indDet <- indDet %>% 
  select(where(~!all(is.na(.)))) 


##  --  SUB NA FOR NON-OPERATIONAL DAYS --  ##

indDet <- indDet %>%
  mutate(across(2:ncol(.), function(x) {
    col_name <- cur_column() # current column
    ifelse(indCams[[col_name]] == 0, NA, x)
  }))

#saveRDS(indDet, file = './Data/detection_allAnimals_independentCams.Rds')

```

```{r umf-independent-cameras}

# Observation Covariates (obsCovs)

names(indDet)[-1] <- paste0(names(indDet)[-1], "/2024") # add year to column names

dates <- colnames(indDet)[-1]
dates <- mdy(dates)

# Ordinal Dates
ordinal <- yday(dates)

# Scale to eliminate collinearity

scOrdinal <- scale(ordinal)

## UMF


y <- as.matrix(indDet[,c(2:ncol(indDet))]) # 0/1 observations


obsCovs <- list(
  scOrdinal = matrix(scOrdinal, 
                  nrow = nrow(y), 
                  ncol = ncol(y), 
                  byrow = TRUE),
  scOrdinal2 = matrix(scOrdinal^2, 
                    nrow = nrow(y),
                    ncol = ncol(y),
                    byrow = TRUE))

# SiteCovs

siteCovs <- indDet$Camera_Name

# unmarkedFrameOccu call

umf_ind <- unmarkedFrameOccu(
  y = y,
  siteCovs = data.frame(site = siteCovs),
  obsCovs = obsCovs
)

#saveRDS(umf_ind, file = "./Data/UMFs/umf_independentCams_allAnimals.Rds")

```

```{r modeling-independent-cams-all-animals}

occu_allAnimals_indCams <- occu(~ scOrdinal + scOrdinal2 ~ 1,
                 data = umf_ind,
                 linkPsi = "logit")

summary(occu_allAnimals_indCams)

```

Detection trend still highly significant

```{r}

ind_pred_occu <- predict(occu_allAnimals_indCams, type = "state")
ind_pred_det <- predict(occu_allAnimals_indCams, type = "det")


cat("Range (occupancy probability):", range(ind_pred_occu$Predicted))
cat("Mean (occupancy probability):", mean(ind_pred_occu$Predicted))

cat("Range (detection probability):", range(ind_pred_det$Predicted))
cat("Mean (detection probability):", mean(ind_pred_det$Predicted))
```

Nearly identical results

# Model 5: Independent cameras, adults only
  - Detection trend
  - Adult animals only

```{r data-prep-independent-cams-adults-only}

adultsOnly_ind <- Occupancy_MGS_Data_Independent_Cameras_Only_Adults_Only

adultsOnly_ind <- adultsOnly_ind %>%
  select(where(~!all(is.na(.))))

indCams <- Occupancy_Operational_Camera_Days_MGS_Data_Independent_Cameras_Only

indCams <- indCams %>%
  select(where(~!all(is.na(.))))

indDet_adults <- adultsOnly_ind %>%
  mutate(across(2:ncol(.), function(x) {
    col_name <- cur_column() # current column
    ifelse(indCams[[col_name]] == 0, NA, x)
  }))

#saveRDS(indDet_adults, file = "./Data/Detection/Detection_NAs_indCams_adultsOnly.Rds")

```

```{r umf-independent-cams-adults-only}

# Covariates

# Observation Covariates (obsCovs)

names(indDet_adults)[-1] <- paste0(names(indDet_adults)[-1], "/2024") # add year to column names

dates <- colnames(indDet_adults)[-1]
dates <- mdy(dates)

# Ordinal Dates
ordinal <- yday(dates)

# Scale to eliminate collinearity

scOrdinal <- scale(ordinal)


## UMF

y <- as.matrix(indDet_adults[,c(2:ncol(indDet_adults))]) # 0/1 observations


obsCovs <- list(
  scOrdinal = matrix(scOrdinal, 
                  nrow = nrow(y), 
                  ncol = ncol(y), 
                  byrow = TRUE),
  scOrdinal2 = matrix(scOrdinal^2, 
                    nrow = nrow(y),
                    ncol = ncol(y),
                    byrow = TRUE))

# SiteCovs

siteCovs <- indDet_adults$Camera_Name

# unmarkedFrameOccu call

umf_ind_adults <- unmarkedFrameOccu(
  y = y,
  siteCovs = data.frame(site = siteCovs),
  obsCovs = obsCovs
)

#saveRDS(umf_ind_adults, file = "./Data/UMFs/umf_independentCams_adults.Rds")


```

```{r modeling-independent-cams-adults-only}

occu_adults_indCams <- occu(~ scOrdinal + scOrdinal2 ~ 1,
                 data = umf_ind_adults,
                 linkPsi = "logit")

summary(occu_adults_indCams)

```

Shockingly, detection trend is still highly significant.

```{r results-independent-cams-adults-only}

ind_adults_pred_occu <- predict(occu_adults_indCams, type = "state")
ind_adults_pred_det <- predict(occu_adults_indCams, type = "det")


cat("Range (occupancy probability):", range(ind_adults_pred_occu$Predicted))
cat("Mean (occupancy probability):", mean(ind_adults_pred_occu$Predicted))

cat("Range (detection probability):", range(ind_adults_pred_det$Predicted))
cat("Mean (detection probability):", mean(ind_adults_pred_det$Predicted))


```

Occupancy probability is exactly the same across all sites, and similar to All Cams with adults only. Detection probability varies across sites.


### ADDING ENVIRONMENTAL COVARIATES

## Model 1: 
  - all animals
  - all cameras
  - Environmental Covariates: Habitat Class (raster), Distance to Stream
  - Random effect of Camera Name
  - Detection effects: date terms
  - Occupancy effects: Env Covs + Camera
  
```{r}

allAnimals_allCams_allCovs_occupancyEffect <- occu(~ scOrdinal + scOrdinal2
                                                   ~ Habitat_Class + 
                                                     Dist_to_Stream + 
                                                     (1|Camera_Name),
                                                   data = umf_env_all,
                                                   linkPsi = "logit")

summary(allAnimals_allCams_allCovs_occupancyEffect)


```

```{r}



```

